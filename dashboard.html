<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thermo Dashboard (MQTT • 6 канала)</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1222;--panel:#111827;--card:#1f2937;
    --text:#e5e7eb;--muted:#94a3b8;--btn-br:#2b3a5a;--btn-br2:#74a7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font:16px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  header{position:sticky;top:0;z-index:10;background:rgba(17,24,39,.85);backdrop-filter:blur(6px);border-bottom:1px solid #ffffff18}
  .wrap{max-width:1180px;margin:auto;padding:14px 18px}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .pill{padding:6px 12px;border-radius:999px;border:1px solid #ffffff22;color:#cbd5e1;font-size:13px}
  .btn{
    appearance:none;background:linear-gradient(180deg,#14213b,#0b1222);color:var(--text);
    border:1px solid var(--btn-br);padding:10px 14px;border-radius:12px;cursor:pointer;
    transition:all .15s ease;box-shadow:0 1px 0 #0008
  }
  .btn:hover{border-color:var(--btn-br2);box-shadow:0 0 0 1px var(--btn-br2) inset}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.6;cursor:not-allowed;box-shadow:none}

  /* Падащите менюта — бял фон, черен текст */
  select{
    appearance:none;background:#fff;color:#111;
    border:1px solid var(--btn-br);padding:10px 14px;border-radius:12px;cursor:pointer;
    transition:all .15s ease;box-shadow:0 1px 0 #0008
  }
  select:hover{border-color:var(--btn-br2);box-shadow:0 0 0 1px var(--btn-br2) inset}
  option{color:#111;background:#fff}

  .grid{display:grid;gap:14px;margin:16px 0;grid-template-columns:repeat(3,1fr)}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--card),#152238);border:1px solid #ffffff18;border-radius:16px;padding:14px}
  .card h3{margin:0 0 6px;font-size:15px;color:#cbd5e1}
  .val{font-size:30px;font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .spark{width:100%;height:56px;border:1px solid #ffffff12;border-radius:8px;background:#0b1222;margin-top:10px}
  a{color:#8ab4ff;text-decoration:none}
  a:hover{text-decoration:underline}
  .log{background:#0b1222;border:1px solid #ffffff18;border-radius:12px;padding:10px;font-family:ui-monospace,Consolas,Menlo,monospace;max-height:160px;overflow:auto}
  .sep{flex:1 0 12px}
</style>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Thermo Dashboard • HiveMQ Cloud (6 канала)</h1>
    <div class="controls">
      <span class="pill">Статус: <span id="status">Изчакване…</span></span>
      <button id="btnConnect" class="btn">Свържи</button>
      <button id="btnDisconnect" class="btn" disabled>Изключи</button>
      <span class="pill">Пакети: <span id="pkts">0</span></span>
      <span class="sep"></span>
      <label>Единици:
        <select id="unitSel">
          <option value="C">°C</option>
          <option value="F">°F</option>
          <option value="K">K</option>
        </select>
      </label>
      <span class="pill"><a href="./log.html">Отиди на Лог</a></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="cards" class="grid"></div>
  <h3 style="margin:8px 0">Системен лог</h3>
  <pre id="log" class="log"></pre>
</main>

<script>
/*** ПОПЪЛНИ ТУК ***/
const HOST  = "8dfb5d8ea05e42479e6203aca4957355.s1.eu.hivemq.cloud";
const PORT  = 8884;           // WSS за браузър
const USER  = "ThermoESP";
const PASS  = "Thermo123";
const TOPIC = "esp32/thermo/values";
/********************/

const fields = ["T1","T2","T3","T4","T5","T6"];
let pkt = 0;
let windowSec = 120; // по подразбиране 2 мин
let unit = "C";      // C|F|K

// UI
const el = {
  status: document.getElementById('status'),
  btnConnect: document.getElementById('btnConnect'),
  btnDisconnect: document.getElementById('btnDisconnect'),
  pkts: document.getElementById('pkts'),
  cards: document.getElementById('cards'),
  log: document.getElementById('log'),
  unitSel: document.getElementById('unitSel'),
  winSel: document.getElementById('winSel'),
};
const log = s => el.log.textContent = `[${new Date().toLocaleTimeString()}] ${s}\n` + el.log.textContent;
const setStatus = s => el.status.textContent = s;

// Картите + мини-графики (пазим точки {t,vC} и режем по време)
const series = {}; // { T1: [{t:ms, v:numberC}, ...], ... }
(function(){
  const frag = document.createDocumentFragment();
  for (const name of fields){
    const c = document.createElement('div');
    c.className = 'card';
    c.innerHTML = `
      <h3>${name}</h3>
      <div class="val" id="v-${name}">—</div>
      <div class="muted" id="t-${name}">—</div>
      <canvas id="c-${name}" class="spark" width="360" height="56"></canvas>`;
    frag.appendChild(c);
    series[name] = [];
  }
  el.cards.appendChild(frag);
})();

// конвертор
function convFromC(vC){
  if (!Number.isFinite(vC)) return null;
  if (unit === 'C') return vC;
  if (unit === 'F') return vC * 9/5 + 32;
  if (unit === 'K') return vC + 273.15;
  return vC;
}
function unitSuffix(){
  return unit === 'C' ? '°C' : unit === 'F' ? '°F' : ' K';
}

// рисуване на последните windowSec секунди
function drawSpark(id, points){
  const cnv = document.getElementById(id);
  if (!cnv) return;
  const ctx = cnv.getContext('2d');
  const w = cnv.width, h = cnv.height;
  ctx.clearRect(0,0,w,h);
  if (!points.length) return;

  const now = Date.now();
  const from = now - windowSec*1000;
  const windowPts = points.filter(p => p.t >= from);
  if (!windowPts.length) return;

  const data = windowPts.map(p => convFromC(p.v)).filter(x=>Number.isFinite(x));
  if (!data.length) return;

  const min = Math.min(...data), max = Math.max(...data), rng = (max-min)||1;
  const step = w / Math.max(1, data.length-1);

  ctx.lineWidth = 1.6;
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = i*step, y = h - ((v-min)/rng)*h;
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#8cc9ff';
  ctx.stroke();
}

// смяна на единици → обнови показаните стойности и графики
el.unitSel.onchange = ()=>{
  unit = el.unitSel.value;
  for (const name of fields){
    const arr = series[name];
    const last = arr.length ? arr[arr.length-1].v : null;
    const vEl = document.getElementById('v-'+name);
    if (vEl) vEl.textContent = last==null ? '—' : `${convFromC(last).toFixed(2)} ${unitSuffix()}`;
    drawSpark('c-'+name, arr);
  }
};
// смяна на интервал → реално сменя времевия прозорец и прерисува

// MQTT
let client=null;
const url = `wss://${HOST}:${PORT}/mqtt`;
const options = { username: USER, password: PASS, reconnectPeriod: 2000, clean:true, connectTimeout: 10000 };

function onMsg(topic, payload){
  try{
    const d = JSON.parse(new TextDecoder().decode(payload));
    const dt = d.datetime || new Date().toISOString();
    const tms = Date.parse(dt) || Date.now();

    for (const name of fields){
      const vC = Number(d[name]); // приемаме, че идва в °C
      if (Number.isFinite(vC)){
        const arr = series[name];
        arr.push({t:tms, v:vC});
        // чистим старите точки извън прозореца
        const from = Date.now() - windowSec*1000;
        while (arr.length && arr[0].t < from) arr.shift();
        // UI
        const vEl = document.getElementById('v-'+name);
        const tEl = document.getElementById('t-'+name);
        if (vEl) vEl.textContent = `${convFromC(vC).toFixed(2)} ${unitSuffix()}`;
        if (tEl) tEl.textContent = dt;
        drawSpark('c-'+name, arr);
      }
    }
    el.pkts.textContent = String(++pkt);
  }catch(e){ log('Parse error: '+(e?.message||e)); }
}

function connect(){
  try{ if (client) client.end(true); }catch{}
  setStatus('Свързване…');
  client = mqtt.connect(url, options);
  client.on('connect', ()=>{ setStatus('Свързан'); client.subscribe(TOPIC); log('Subscribed: '+TOPIC); el.btnDisconnect.disabled=false; el.btnConnect.disabled=true; });
  client.on('reconnect', ()=> setStatus('Повторен опит…'));
  client.on('error', (e)=> { setStatus('Грешка'); log('ERR '+(e?.message||e)); });
  client.on('close', ()=>{ setStatus('Изключено'); el.btnDisconnect.disabled=true; el.btnConnect.disabled=false; });
  client.on('message', onMsg);
}
function disconnect(){ try{ if (client) client.end(true); }catch{} }

el.btnConnect.onclick = connect;
el.btnDisconnect.onclick = disconnect;
window.addEventListener('error', (e)=> log('JS Error: '+e.message));
window.addEventListener('unhandledrejection', (e)=> log('Promise: '+(e.reason?.message||e.reason)));
window.addEventListener('load', connect);
</script>
</body>
</html>
